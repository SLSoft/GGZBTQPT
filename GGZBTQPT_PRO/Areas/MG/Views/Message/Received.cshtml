@model Webdiyer.WebControls.Mvc.PagedList<GGZBTQPT_PRO.Models.T_HY_Message>

@helper StyledDate(DateTime date_time)
{
    if(@date_time.Year == DateTime.Now.Year)
    {
        <h4>@date_time.Month - @date_time.Day</h4>
        <span>@date_time.ToShortTimeString()</span>
    }
    else
    {
        <h3>@date_time.Year</h3>
        <h4>@date_time.Month - @date_time.Day</h4>
        <span>@date_time.ToShortTimeString()</span>
    }

}

@helper FormatReply(string member_name, string date_time)
{
    if(member_name == ViewBag.current_member.MemberName)
    {
        <h4>你在 @date_time 回复道:</h4>
    }
    else
    {
        <h4>@member_name 在 @date_time 说道:</h4>
    }
}
<div id="sended">
    @*发送消息信息*@
    <ul class="media-list">
        @foreach (var _model in Model)
        {    
            <li class="media" ><a class="pull-left" href="#">@StyledDate(@_model.CreatedTime)</a>
                <div class="media-body message" id="@_model.ID.ToString()message">
                    <h4 class="media-heading">@_model.Title
                    <span class="pull-right view_all_replies">
                        查看相关回复
                    </span>
                    </h4>
                    @_model.Content
                    <div class="replies">
                        @foreach (var reply in _model.Replies)
                        {
                            <div class="media reply well">
                                <div class="media-body">
                                    @FormatReply(@reply.Member.MemberName, @reply.CreatedTime.ToShortTimeString())
                                    @reply.Content
                                </div>
                            </div>
                        } 
                    </div>
                    <h5 class="media-heading reply-to">
                        @Ajax.ActionLink("回复该消息", "Create", "Reply", new { message_id = @_model.ID },
                                        new AjaxOptions
                                        {
                                            HttpMethod = "GET",
                                            UpdateTargetId = _model.ID.ToString() + "replying",
                                            LoadingElementId = "Loading"
                                        })
                    </h5>
                    <div id="@_model.ID.ToString()replying">
                    </div>
                </div>
            </li>
        }
    </ul>
</div>
<div class="pagination pagination-right pagination-small">
    @Html.AjaxPager(Model,
    new PagerOptions
    {
        PageIndexParameterName = "id",
        ContainerTagName = "ul",
        CurrentPagerItemWrapperFormatString = "<li class='active'><a href='#'>{0}</a></li>",
        PagerItemWrapperFormatString = "<li>{0}</li>"
    },
    new AjaxOptions { HttpMethod = "GET", UpdateTargetId = "details" })
</div>


<script type="text/javascript">
    function notice(data) {
        $.Member.notice(data);
        updateReplies(data.reply_id, data.message_id);
    }

    function updateReplies(reply_id, message_id) {
        $.get("/MG/Reply/Details/" + reply_id, function (data) {
            $("#" + message_id + "message").children("div[class$='replies']").append(data).toggle();
        });
    }
    $.Member.replaceBlankForMVCPager();
    $.Member.rounded();
    $.Member.viewAllReplies();
</script>




